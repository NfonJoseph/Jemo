generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  VENDOR
  DELIVERY_AGENCY  // Admin-created only, replaces RIDER
  ADMIN
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING           // Order created, awaiting payment confirmation (or COD)
  CONFIRMED         // Payment confirmed / COD accepted, vendor notified
  IN_TRANSIT        // Order picked up by delivery, on the way to customer
  DELIVERED         // Delivered to customer
  COMPLETED         // Customer confirmed receipt, funds released to vendor
  CANCELLED         // Order cancelled
}

// Who cancelled the order
enum CancelledBy {
  CUSTOMER
  VENDOR
  ADMIN
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum DeliveryStatus {
  SEARCHING_RIDER
  ASSIGNED
  PICKED_UP
  ON_THE_WAY
  DELIVERED
  CANCELLED
}

enum DeliveryJobStatus {
  OPEN            // Job is available for agencies to accept
  ACCEPTED        // Agency has accepted the job
  DELIVERED       // Successfully delivered
  CANCELLED       // Job was cancelled
}

enum DeliveryType {
  VENDOR_DELIVERY
  JEMO_RIDER
}

enum DealType {
  TODAYS_DEAL
  FLASH_SALE
}

enum ProductStatus {
  PENDING_APPROVAL  // Default: awaiting admin review
  APPROVED          // Admin approved, visible publicly
  REJECTED          // Admin rejected with comment
  SUSPENDED         // Temporarily suspended by admin
}

enum StockStatus {
  IN_STOCK
  OUT_OF_STOCK
}

enum ProductCondition {
  NEW
  USED_LIKE_NEW
  USED_GOOD
  REFURBISHED
}

enum PaymentPolicy {
  POD_ONLY          // Pay on Delivery only
  ONLINE_ONLY       // Online payment only (MTN MoMo / Orange Money)
  MIXED_CITY_RULE   // COD for same city, Online for different cities
}

enum VendorApplicationType {
  BUSINESS
  INDIVIDUAL
}

enum VendorApplicationStatus {
  DRAFT
  PENDING_PAYMENT
  PENDING_MANUAL_VERIFICATION
  PENDING_KYC_REVIEW
  APPROVED
  REJECTED
}

enum UploadKind {
  TAXPAYER_DOC
  ID_FRONT
  ID_BACK
  SELFIE
}

// =============================================
// VENDOR WALLET ENUMS
// =============================================

enum WalletTransactionType {
  CREDIT_PENDING     // Funds credited but held (e.g., order placed)
  CREDIT_AVAILABLE   // Funds moved from pending to available (e.g., order delivered)
  DEBIT_WITHDRAWAL   // Funds withdrawn to vendor's mobile money
  REVERSAL           // Reversal of a previous transaction (e.g., order cancelled)
}

enum WalletTransactionReferenceType {
  ORDER              // Reference to an order
  PAYOUT             // Reference to a payout request
  ADJUSTMENT         // Manual adjustment by admin
}

enum WalletTransactionStatus {
  PENDING            // Transaction initiated but not yet final
  POSTED             // Transaction finalized and applied to balance
  CANCELLED          // Transaction cancelled/reversed
}

enum PayoutStatus {
  REQUESTED          // Vendor requested withdrawal
  PROCESSING         // Being processed with payment provider
  SUCCESS            // Successfully paid out
  FAILED             // Failed to pay out
}

enum PayoutMethod {
  CM_MOMO            // Cameroon MTN Mobile Money
  CM_OM              // Cameroon Orange Money
}

// Order Payment Method (how customer pays)
enum OrderPaymentMethod {
  COD                // Cash on Delivery
  MYCOOLPAY          // Online payment via My-CoolPay (MTN MoMo / Orange Money)
}

model User {
  id            String         @id @default(cuid())
  phone         String         @unique  // Canonical E.164 format: +237XXXXXXXXX
  email         String?        @unique  // Optional, for notifications
  passwordHash  String
  role          UserRole
  name          String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  vendorProfile         VendorProfile?
  deliveryAgency        DeliveryAgency?
  orders                Order[]
  disputes              Dispute[]
  vendorApplications    VendorApplication[]
  favorites             Favorite[]
  reviews               Review[]

  @@map("users")
}

model VendorProfile {
  id            String      @id @default(cuid())
  userId        String      @unique
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessName  String
  businessAddress String
  kycStatus     KycStatus   @default(PENDING)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  kycSubmissions KycSubmission[]
  products       Product[]
  reviews        Review[]

  @@map("vendor_profiles")
}

// Delivery Agency - Admin-created only
model DeliveryAgency {
  id            String      @id @default(cuid())
  userId        String      @unique
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Agency Information
  name          String
  phone         String
  email         String?
  address       String
  citiesCovered String[]    // Array of cities this agency can deliver to
  
  // Pricing (in XAF)
  feeSameCity   Int         @default(1500)  // Fee when pickup and dropoff are in same city
  feeOtherCity  Int         @default(2500)  // Fee when pickup and dropoff are in different cities
  currency      String      @default("XAF")
  
  // Status
  isActive      Boolean     @default(true)  // Only active agencies receive delivery jobs
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  deliveries    Delivery[]
  deliveryJobs  DeliveryJob[]
  wallet        AgencyWallet?
  payoutProfile AgencyPayoutProfile?

  @@map("delivery_agencies")
}

// Delivery Job - Created when order is READY_FOR_PICKUP
model DeliveryJob {
  id              String              @id @default(cuid())
  
  // Order reference (unique - one job per order)
  orderId         String              @unique
  order           Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Pickup details (from vendor)
  pickupAddress   String
  pickupCity      String
  
  // Dropoff details (customer's delivery address)
  dropoffAddress  String
  dropoffCity     String
  
  // Delivery Fee (copied from order at job creation)
  fee             Int?                // Fee in XAF (renamed from deliveryFee for clarity)
  
  // Status
  status          DeliveryJobStatus   @default(OPEN)
  
  // Assignment (nullable until an agency accepts)
  agencyId        String?             // Assigned agency (renamed from assignedAgencyId)
  agency          DeliveryAgency?     @relation(fields: [agencyId], references: [id])
  acceptedAt      DateTime?
  
  // Timestamps
  deliveredAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Audit logs
  logs            DeliveryJobLog[]

  @@map("delivery_jobs")
}

// Audit log for delivery job events
model DeliveryJobLog {
  id              String              @id @default(cuid())
  
  deliveryJobId   String
  deliveryJob     DeliveryJob         @relation(fields: [deliveryJobId], references: [id], onDelete: Cascade)
  
  // Event details
  event           String              // CREATED, ACCEPTED, STATUS_CHANGED, ADMIN_ASSIGNED, etc.
  previousStatus  String?
  newStatus       String?
  
  // Actor (who performed the action)
  actorId         String?             // User ID who performed action
  actorType       String              // SYSTEM, AGENCY, ADMIN, CUSTOMER
  actorName       String?             // Name for display purposes
  
  // Additional metadata
  notes           String?
  metadata        String?             // JSON string for extra data
  
  createdAt       DateTime            @default(now())

  @@index([deliveryJobId])
  @@map("delivery_job_logs")
}

model KycSubmission {
  id                      String                  @id @default(cuid())
  vendorProfileId         String?
  vendorProfile           VendorProfile?          @relation(fields: [vendorProfileId], references: [id], onDelete: Cascade)
  documentType            String
  documentUrl             String
  status                  KycStatus               @default(PENDING)
  reviewedAt              DateTime?
  reviewNotes             String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt

  @@map("kyc_submissions")
}

// Product Categories Table
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  nameEn      String
  nameFr      String
  slug        String    @unique
  description String?
  icon        String?   // Icon name or URL
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@map("categories")
}

model Product {
  id              String          @id @default(cuid())
  vendorProfileId String
  vendorProfile   VendorProfile   @relation(fields: [vendorProfileId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name            String
  description     String
  categoryId      String
  category        Category        @relation(fields: [categoryId], references: [id])
  
  // Pricing
  price           Decimal         @db.Decimal(10, 2)  // Selling price
  discountPrice   Decimal?        @db.Decimal(10, 2)  // Fixed discount price (optional)
  
  // Stock
  stock           Int             @default(0)
  stockStatus     StockStatus     @default(IN_STOCK)
  
  // Location
  city            String          // Product location city
  
  // Delivery
  deliveryType    DeliveryType    // VENDOR_DELIVERY or JEMO_RIDER
  
  // Vendor Delivery Options (only if deliveryType = VENDOR_DELIVERY)
  pickupAvailable     Boolean     @default(false)
  localDelivery       Boolean     @default(false)
  nationwideDelivery  Boolean     @default(false)
  
  // Vendor Delivery Fees (only if deliveryType = VENDOR_DELIVERY)
  freeDelivery        Boolean     @default(false)
  flatDeliveryFee     Decimal?    @db.Decimal(10, 2)  // If not free and flat fee
  sameCityDeliveryFee Decimal?    @db.Decimal(10, 2)  // If varies by city
  otherCityDeliveryFee Decimal?   @db.Decimal(10, 2)  // If varies by city
  
  // Condition & Authenticity
  condition           ProductCondition @default(NEW)
  authenticityConfirmed Boolean    @default(false)
  
  // Payment Policy
  paymentPolicy       PaymentPolicy    @default(POD_ONLY)  // Default to Pay on Delivery
  mtnMomoEnabled      Boolean          @default(true)      // MTN Mobile Money enabled
  orangeMoneyEnabled  Boolean          @default(true)      // Orange Money enabled
  
  // Status & Approval
  status          ProductStatus   @default(PENDING_APPROVAL)
  rejectionReason String?         // Admin rejection comment
  reviewedAt      DateTime?       // When admin reviewed
  reviewedById    String?         // Admin user ID who reviewed
  
  // Deal type and flash sale fields (admin controlled)
  dealType                DealType  @default(TODAYS_DEAL)
  flashSalePrice          Decimal?  @db.Decimal(10, 2)
  flashSaleDiscountPercent Int?
  flashSaleStartAt        DateTime?
  flashSaleEndAt          DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  images     ProductImage[]
  orderItems OrderItem[]
  favorites  Favorite[]
  reviews    Review[]

  @@map("products")
}

model ProductImage {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  objectKey   String   // R2 object key: products/{vendorId}/{productId}/{uuid}.{ext}
  url         String   // Public/signed URL
  mimeType    String
  size        Int      // File size in bytes
  sortOrder   Int      @default(0)  // For reordering
  isMain      Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@map("product_images")
}

// Admin Settings for Jemo Delivery Pricing
model AdminSettings {
  id                  String   @id @default(cuid())
  key                 String   @unique
  value               String   // JSON string for complex values
  description         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("admin_settings")
}

model Order {
  id              String              @id @default(cuid())
  customerId      String
  customer        User                @relation(fields: [customerId], references: [id], onDelete: Cascade)
  status          OrderStatus         @default(PENDING)
  totalAmount     Decimal             @db.Decimal(10, 2)
  
  // Delivery information
  deliveryAddress String
  deliveryPhone   String
  deliveryCity    String?             // Buyer's selected delivery city
  productCity     String?             // Snapshot of product city at order time
  deliveryMethod  DeliveryType?       // VENDOR_DELIVERY or JEMO_RIDER
  deliveryFee     Int?                // Delivery fee in XAF (integer)
  deliveryFeeAgencyId String?         // Agency used for fee calculation (if Jemo Delivery)
  deliveryFeeRule     String?         // SAME_CITY or OTHER_CITY - which pricing rule was applied
  
  // Cancellation info
  cancelledBy     CancelledBy?        // Who cancelled the order
  cancelReason    String?             // Reason for cancellation
  
  // Payment method used for this order
  paymentMethod   OrderPaymentMethod  @default(COD)
  
  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  confirmedAt     DateTime?           // When order was confirmed
  inTransitAt     DateTime?           // When order went in transit
  deliveredAt     DateTime?           // When order was delivered
  completedAt     DateTime?           // When customer confirmed receipt
  cancelledAt     DateTime?           // When order was cancelled
  
  // Earnings breakdown (set when order is completed)
  // All amounts in XAF (integer stored as Decimal for consistency)
  subtotalAmount      Decimal?        @db.Decimal(10, 2)  // Product subtotal (before delivery)
  commissionAmount    Decimal?        @db.Decimal(10, 2)  // Jemo commission (0 for now)
  commissionRate      Decimal?        @db.Decimal(5, 4)   // Commission rate (e.g., 0.05 for 5%)
  vendorPayoutAmount  Decimal?        @db.Decimal(10, 2)  // Amount to vendor (subtotal - commission)
  fundsReleasedAt     DateTime?       // When funds were credited to vendor wallet

  items       OrderItem[]
  payment     Payment?
  delivery    Delivery?
  deliveryJob DeliveryJob?
  disputes    Dispute[]

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@map("order_items")
}

model Payment {
  id                  String        @id @default(cuid())
  orderId             String        @unique
  order               Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount              Decimal       @db.Decimal(10, 2)
  currency            String        @default("XAF")
  status              PaymentStatus @default(INITIATED)
  paymentMethod       String        // MTN_MOBILE_MONEY, ORANGE_MONEY, COD
  provider            String?       // MYCOOLPAY, etc.
  appTransactionRef   String?       @unique  // Our unique idempotent reference
  providerTransactionId String?     // Provider's transaction ID
  providerResponse    String?       // JSON string of provider response
  failureReason       String?       // Error details if failed
  webhookReceivedAt   DateTime?     // When we received webhook confirmation
  paidAt              DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@map("payments")
}

// Fee payments (vendor application, etc.)
model FeePayment {
  id                    String        @id @default(cuid())
  userId                String
  purpose               String        // VENDOR_APPLICATION_FEE, RIDER_APPLICATION_FEE, etc.
  applicationId         String?       // Reference to VendorApplication or RiderApplication
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("XAF")
  status                PaymentStatus @default(INITIATED)
  paymentMethod         String        // MTN_MOBILE_MONEY, ORANGE_MONEY
  provider              String?       // MYCOOLPAY
  appTransactionRef     String        @unique  // Our unique idempotent reference
  providerTransactionId String?       // Provider's transaction ID
  providerResponse      String?       // JSON string of provider response
  failureReason         String?       // Error details if failed
  webhookReceivedAt     DateTime?     // When we received webhook confirmation
  paidAt                DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  @@map("fee_payments")
}

// Pre-order payment intent (for ONLINE_ONLY products)
// Created before order, order is created only after payment succeeds
model PaymentIntent {
  id                    String        @id @default(cuid())
  userId                String
  productId             String
  vendorId              String        // Vendor user ID for the product
  quantity              Int           @default(1)  // Quantity of product
  productSubtotal       Int           // Product price * quantity (after discounts)
  deliveryFee           Int           @default(0)  // Delivery fee
  deliveryCity          String?       // Customer's delivery city
  deliveryMethod        String?       // JEMO_RIDER or VENDOR_SELF
  totalAmount           Int           // productSubtotal + deliveryFee (what customer pays)
  currency              String        @default("XAF")
  operator              String        // MTN_MOBILE_MONEY or ORANGE_MONEY
  customerPhone         String        // Customer's phone number for payment
  status                PaymentStatus @default(INITIATED)
  appTransactionRef     String        @unique  // Our unique idempotent reference
  providerTransactionId String?       // MyCoolPay transaction ID
  providerResponse      String?       // JSON string of provider response
  failureReason         String?       // Error details if failed
  usedForOrderId        String?       // Order ID if used to create an order
  expiresAt             DateTime      // When this intent expires (e.g., 30 min)
  paidAt                DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  @@index([userId])
  @@index([appTransactionRef])
  @@map("payment_intents")
}

model Delivery {
  id                      String                  @id @default(cuid())
  orderId                 String                  @unique
  order                   Order                   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  deliveryAgencyId        String?
  deliveryAgency          DeliveryAgency?         @relation(fields: [deliveryAgencyId], references: [id])
  deliveryType            DeliveryType
  status                  DeliveryStatus          @default(SEARCHING_RIDER)
  pickedUpAt              DateTime?
  deliveredAt             DateTime?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt

  @@map("deliveries")
}

model Dispute {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  customerId  String
  customer    User     @relation(fields: [customerId], references: [id])
  reason      String
  description String
  resolution  String?
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("disputes")
}

// =============================================
// VENDOR APPLICATION (Multi-step wizard)
// =============================================

model VendorApplication {
  id                    String                   @id @default(cuid())
  userId                String
  user                  User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type                  VendorApplicationType
  status                VendorApplicationStatus  @default(DRAFT)
  
  // Business path fields
  businessName          String?
  businessAddress       String?
  businessPhone         String?                  // Normalized +237XXXXXXXXX
  businessEmail         String?
  
  // Individual path fields
  fullNameOnId          String?
  location              String?
  phoneNormalized       String?                  // Normalized +237XXXXXXXXX
  
  // Payment tracking
  applicationFeePaid    Boolean                  @default(false)
  feePaymentId          String?                  // Reference to Payment record
  paymentRef            String?                  // Transaction reference
  paidAt                DateTime?
  
  // Admin review
  rejectionReason       String?
  reviewedAt            DateTime?
  reviewedBy            String?                  // Admin user ID
  
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  
  uploads               VendorApplicationUpload[]
  
  @@map("vendor_applications")
}

model VendorApplicationUpload {
  id              String            @id @default(cuid())
  applicationId   String
  application     VendorApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  kind            UploadKind
  storagePath     String            // Local path or S3 key
  originalName    String
  mimeType        String
  size            Int               // File size in bytes
  createdAt       DateTime          @default(now())
  
  @@unique([applicationId, kind])  // One file per kind per application
  @@map("vendor_application_uploads")
}

// =============================================
// FAVORITES / WISHLIST
// =============================================

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])  // One favorite per user per product
  @@map("favorites")
}

// =============================================
// REVIEWS
// =============================================

model Review {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendorProfileId String
  vendorProfile   VendorProfile @relation(fields: [vendorProfileId], references: [id], onDelete: Cascade)
  productId       String
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItemId     String        // Reference to the specific order item being reviewed
  rating          Int           // 1-5 stars
  comment         String?       // Optional text review
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([userId, orderItemId])  // One review per user per order item
  @@map("reviews")
}

// =============================================
// VENDOR WALLET INFRASTRUCTURE
// =============================================

// VendorWallet: One wallet per vendor user
// All money amounts are stored as integer XAF (no decimals)
model VendorWallet {
  id               String   @id @default(cuid())
  vendorId         String   @unique  // Links to User.id where role = VENDOR
  
  // Balances in integer XAF
  availableBalance Int      @default(0)  // Funds available for withdrawal
  pendingBalance   Int      @default(0)  // Funds held pending order completion
  
  // Withdrawal controls
  withdrawalsLocked    Boolean   @default(false)  // Admin can lock for fraud prevention
  lockReason           String?                     // Reason for locking
  lockedAt             DateTime?                   // When locked
  lockedById           String?                     // Admin who locked
  lastWithdrawalAt     DateTime?                   // For rate limiting
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  transactions     WalletTransaction[]
  payouts          Payout[]

  @@map("vendor_wallets")
}

// WalletTransaction: Ledger of all wallet balance changes
// All amounts are stored as integer XAF (positive values)
model WalletTransaction {
  id            String                        @id @default(cuid())
  walletId      String
  wallet        VendorWallet                  @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Transaction details
  type          WalletTransactionType         // CREDIT_PENDING, CREDIT_AVAILABLE, DEBIT_WITHDRAWAL, REVERSAL
  amount        Int                           // Amount in XAF (always positive)
  currency      String                        @default("XAF")
  
  // Reference to what caused this transaction
  referenceType WalletTransactionReferenceType // ORDER, PAYOUT, ADJUSTMENT
  referenceId   String                        // ID of the order, payout, or adjustment
  
  // Status
  status        WalletTransactionStatus       @default(PENDING)
  
  // Optional note (for adjustments or reversals)
  note          String?
  
  createdAt     DateTime                      @default(now())

  // Prevent duplicate credits for the same order/reference
  // e.g., can't credit the same order twice with CREDIT_PENDING
  @@unique([referenceType, referenceId, type])
  @@index([walletId])
  @@index([referenceId])
  @@map("wallet_transactions")
}

// Payout: Vendor withdrawal request to mobile money
model Payout {
  id                String        @id @default(cuid())
  vendorId          String        // Links to User.id where role = VENDOR
  walletId          String
  wallet            VendorWallet  @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Amount in integer XAF
  amount            Int
  
  // Status tracking
  status            PayoutStatus  @default(REQUESTED)
  
  // Payout method and destination
  method            PayoutMethod  // CM_MOMO, CM_OM
  destinationPhone  String        // E.164 format: +237XXXXXXXXX
  
  // Our unique idempotent transaction reference
  appTransactionRef String        @unique
  
  // Payment provider response data
  providerRef       String?       // Provider's transaction ID
  providerRaw       Json?         // Full provider response as JSON
  failureReason     String?       // Error details if failed
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  processedAt       DateTime?     // When payout was completed/failed

  @@index([vendorId])
  @@index([walletId])
  @@index([status])
  @@map("payouts")
}

// =============================================
// DELIVERY AGENCY WALLET SYSTEM
// =============================================

// AgencyWallet: Holds delivery fee earnings for delivery agencies
model AgencyWallet {
  id               String   @id @default(cuid())
  agencyId         String   @unique  // Links to DeliveryAgency.id
  agency           DeliveryAgency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  
  // Balances in integer XAF
  availableBalance Int      @default(0)  // Funds available for withdrawal
  pendingBalance   Int      @default(0)  // Funds held pending order delivery
  
  // Withdrawal controls
  withdrawalsLocked    Boolean   @default(false)  // Admin can lock for fraud prevention
  lockReason           String?                     // Reason for locking
  lockedAt             DateTime?                   // When locked
  lockedById           String?                     // Admin who locked
  lastWithdrawalAt     DateTime?                   // For rate limiting
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  transactions     AgencyWalletTransaction[]
  payouts          AgencyPayout[]

  @@map("agency_wallets")
}

// AgencyWalletTransaction: Ledger of all agency wallet balance changes
model AgencyWalletTransaction {
  id            String                        @id @default(cuid())
  walletId      String
  wallet        AgencyWallet                  @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Transaction details
  type          WalletTransactionType         // CREDIT_PENDING, CREDIT_AVAILABLE, DEBIT_WITHDRAWAL, REVERSAL
  amount        Int                           // Amount in XAF (always positive)
  currency      String                        @default("XAF")
  
  // Reference to what caused this transaction
  referenceType WalletTransactionReferenceType // ORDER, PAYOUT, ADJUSTMENT
  referenceId   String                        // ID of the order, payout, or adjustment
  
  // Status
  status        WalletTransactionStatus       @default(PENDING)
  
  // Optional note (for adjustments or reversals)
  note          String?
  
  createdAt     DateTime                      @default(now())

  // Prevent duplicate credits for the same order/reference
  @@unique([referenceType, referenceId, type])
  @@index([walletId])
  @@index([referenceId])
  @@map("agency_wallet_transactions")
}

// AgencyPayout: Delivery agency withdrawal request to mobile money
model AgencyPayout {
  id                String        @id @default(cuid())
  agencyId          String        // Links to DeliveryAgency.id
  walletId          String
  wallet            AgencyWallet  @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Amount in integer XAF
  amount            Int
  
  // Status tracking
  status            PayoutStatus  @default(REQUESTED)
  
  // Payout method and destination
  method            PayoutMethod  // CM_MOMO, CM_OM
  destinationPhone  String        // E.164 format: +237XXXXXXXXX
  
  // Our unique idempotent transaction reference
  appTransactionRef String        @unique
  
  // Payment provider response data
  providerRef       String?       // Provider's transaction ID
  providerRaw       Json?         // Full provider response as JSON
  failureReason     String?       // Error details if failed
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  processedAt       DateTime?     // When payout was completed/failed

  @@index([agencyId])
  @@index([walletId])
  @@index([status])
  @@map("agency_payouts")
}

// =============================================
// VENDOR PAYOUT PROFILE (Withdrawal destination settings)
// =============================================

// VendorPayoutProfile: Stores vendor's preferred withdrawal destination
model VendorPayoutProfile {
  id              String       @id @default(cuid())
  vendorId        String       @unique  // Links to User.id where role = VENDOR
  
  // Preferred payout method
  preferredMethod PayoutMethod // CM_MOMO or CM_OM
  
  // Destination phone in canonical E.164 format: +237XXXXXXXXX
  phone           String
  
  // Full name of account holder (for verification)
  fullName        String
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("vendor_payout_profiles")
}

// =============================================
// AGENCY PAYOUT PROFILE (Withdrawal destination settings for delivery agencies)
// =============================================

// AgencyPayoutProfile: Stores agency's preferred withdrawal destination
model AgencyPayoutProfile {
  id              String       @id @default(cuid())
  agencyId        String       @unique  // Links to DeliveryAgency.id
  
  // Preferred payout method
  preferredMethod PayoutMethod // CM_MOMO or CM_OM
  
  // Destination phone in canonical E.164 format: +237XXXXXXXXX
  phone           String
  
  // Full name of account holder (for verification)
  fullName        String
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relation
  agency          DeliveryAgency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@map("agency_payout_profiles")
}
